
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Data modelling &#8212; Comp350: Software design v1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Concurrency and parallelism" href="par.html" />
    <link rel="prev" title="Representational State Transfer (REST)" href="rest.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="data-modelling">
<h1>Data modelling<a class="headerlink" href="#data-modelling" title="Permalink to this heading">¶</a></h1>
<p>In the previous section, we saw how a “service” can be modelled as a “manager
of resources on behalf of a client” and how to construct references for these
managed “resources” for the purpose of interacting with the service via
transfer of “representations” – the “REST” (REpresentational State Transfer)
approach.</p>
<p>In this section, we’ll take off on the “todo list” API constructed in class
based on a global variable as the storage and consider how to store and
retrieve the information using a relational database in a persistent manner.
With the service constructed in class, restarting the server will cause it to
forget all the todo items it had stored earlier and that’s what we want to
address.</p>
<p>The “resource” way of thinking about the service translates fairly easily onto
a relational database. We’ll assume you’ve already dealt with relational
databases at a conceptual level, but haven’t actually used one for data
modelling.</p>
<section id="tables">
<h2>Tables<a class="headerlink" href="#tables" title="Permalink to this heading">¶</a></h2>
<p>The core data structure in a relational database is the <strong>table</strong>, whose rows
capture related values of some aspect of the data. Hence “relational database”.
In the case of the todo list, we can think of the todo list itself as a table,
whose rows give information about each of the items in the list. We saw that
each list item has a number of attributes to keep track of.</p>
<ol class="arabic simple">
<li><p>The URI or equivalently the <code class="docutils literal notranslate"><span class="pre">id</span></code> of a todo item. We can consider them
to be equivalent because the URL of the todo item can be derived if we
know the <code class="docutils literal notranslate"><span class="pre">id</span></code> of the item and vice versa.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">text</span></code> of the TODO item.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">done</span></code> state of the TODO item.</p></li>
</ol>
<p>We could add more attributes to the above list, but that wouldn’t lead us to
any new concepts beyond what we used for the above, so you can take that as an
exercise to extend it with more information such as “creation date-time”,
“completion date-time”, “priority” etc.</p>
<table class="docutils align-default" id="id2">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">TODOList</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>id</p></th>
<th class="head"><p>text</p></th>
<th class="head"><p>status</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Model the todolist app as resources</p></td>
<td><p>complete</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Create a relational data model</p></td>
<td><p>pending</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Specify the schema for the data model in SQL</p></td>
<td><p>pending</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>Create the tables in sqlite3</p></td>
<td><p>pending</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>Implement the service handlers to use the sqlite3 db instead of the global variable</p></td>
<td><p>pending</p></td>
</tr>
</tbody>
</table>
<p id="index-0">Notice that in the above table, we’re considering our “id” column to be an
integer, the “text” column to have, well, text values and the “status” column
to also have text value with only two values allowed – “complete” or
“pending”. The “status” column is a effectively a boolean and could also have
been modelled as an integer with <code class="docutils literal notranslate"><span class="pre">0</span></code> standing for “incomplete” and <code class="docutils literal notranslate"><span class="pre">1</span></code>
standing for “completeyes”. Similarly, you may want to use a string as an
identifier for a todo item as well, instead of an integer. Such a description
of the table is called its “schema”.</p>
<p id="index-1">There are always such choices to be made when constructing a data model.
Sometimes these choices don’t feel very consequential, such as perhaps in our
case so far, but if there is more information available, the choices may have
real consequences. For example, suppose we know that there is an upcoming
feature for our todolist app where the status of the todolist item can be an
arbitrary word given by the user, such as “pending”, “WIP”, “done”, “archived”,
etc. In such a case, the text representation for that column has a clear
advantage over the integer/boolean representation, since we’ll then have to
overhaul the table and change its schema (called a “schema migration”).</p>
<p>Now that we’ve acknowledged that our app will evolve over time and so might
our table “schema”, we should perhaps keep some metadata about our schema
– its “version number” to start with.</p>
<table class="docutils align-default" id="id3">
<caption><span class="caption-number">Table 2 </span><span class="caption-text">metadata</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>schema</p></th>
<th class="head"><p>version</p></th>
<th class="head"><p>date</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>todolist</p></td>
<td><p>1</p></td>
<td><p>2024-08-25</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The metadata table itself has a schema, but we expect it to change
much less frequently than the other table schemas. While we’ve only captured
the version number for simplicity, it is common to maintain a table of
instructions on how to migrate from version <span class="math notranslate nohighlight">\(n\)</span> to version
<span class="math notranslate nohighlight">\(n+1\)</span>, along with the current version, so that the migration steps can
be run automatically. We’ll not go there yet.</p>
</div>
</section>
<section id="sql">
<h2>SQL<a class="headerlink" href="#sql" title="Permalink to this heading">¶</a></h2>
<p>The “Structured Query Language” – abbreviated “SQL” and pronounced “sequel” –
is a ubiquitous language used in describing data and interacting with
relational databases. The advantage of SQL is that it abstracts the details of
how the data is actually stored by a given database, and thus permits the
programmer to think and work at the level of the data they need to work with.</p>
<p><a class="reference external" href="https://www.sqlite.org/index.html">SQLite</a> is a ubiquitous, simple yet powerful such database which stores all its
data in a single file and makes it available for manipulation via SQL.
Different databases have slightly different variations of the SQL language they
support, but these differences are far less important than the substantial
commonality that exists between them.</p>
<p>Other common larger scale databases in use include <a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a> and <a class="reference external" href="https://www.mysql.com/">MySQL</a>. In
my opinion, of the relational databases available today, <a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a> is perhaps
the best of the cadre w.r.t. its engineering and the ecosystem of extensions
available for it.</p>
<p>There are also a class of databases called “NoSQL” databases which came up
during a period of (in my opinion) irrational backlash against the perceived
complexity of SQL databases. Our general advice is that if you don’t know
enough to choose a database, choose one which has a SQL interface and don’t
choose a “NoSQL” database (such as “MongoDB”).</p>
</section>
<section id="id1">
<h2>SQLite3<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h2>
<p>As mentioned, we’ll be using the “SQLite v3” as a simple database storage for
our todolist app’s backend.</p>
<p>Python comes with the <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> package preinstalled usually. In case your
installation does not have it, you can always install it with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span>
<span class="pre">sqlite3</span></code>.</p>
<p>The <a class="reference external" href="https://www.sqlite.org/index.html">sqlite3 documentation</a> is the canonical place to go to for information
about the supported commands. Its documentation is excellent even for beginners
and it provides “railroad diagrams” that illustrate the syntax.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SQL syntax is not case sensitive for its keywords.</p>
</div>
<p>The process for opening a sqlite3 database and sending it commands to manipulate
and query data is as follows –</p>
<ol class="arabic simple">
<li><p>“Connect” to the database. The language used here generalizes different
locations for the database – a) in-memory, b) on disk or c) on another
computer over the network. This step gets you a database connection.</p></li>
<li><p>When you want to do something with the database, you create a “cursor”
object from the connection and ask it to execute your SQL commands given as
a string.</p></li>
<li><p>Once you’re done with the cursor object you created, you close the cursor.</p></li>
</ol>
<p>The above is the simplest of usage scenarios and is a common mode of usage
across different databases. The process might vary a bit, for example, when you
have to deal with a long running “transaction”.</p>
<div class="admonition-sqlite3-repl admonition">
<p class="admonition-title"><strong>sqlite3 repl</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> comes with a repl you can run from the shell using <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code>.
You can run SQL commands as well as what are called “meta commands” which
start with a period “.” character. When writing SQL on the repl, the SQL statements
can be multi-line and are terminated by a “;”.</p>
</div>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">todolist</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="nb">text</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The above SQL command does what it looks like it is supposed to do – create a
table with three columns with the given types. The part that needs explanation
is <code class="docutils literal notranslate"><span class="pre">PRIMARY</span> <span class="pre">KEY</span></code>. This phrase when used next to the type of a column
indicates that that column serves as a unique index to identify a row. So the
database will ensure that the table will not have more than one row with the
same “id” value in our case.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Within the context of a database, such a “create table” statement is called
the “schema” of the table named “todolist”.</p>
</div>
</section>
<section id="insert-data">
<h2>Insert data<a class="headerlink" href="#insert-data" title="Permalink to this heading">¶</a></h2>
<p>Now let’s consider the commands to insert new rows into our brand new <code class="docutils literal notranslate"><span class="pre">todolist</span></code>
table.</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">todolist</span><span class="w"> </span><span class="k">values</span>
<span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Model the todolist app as resources&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;complete&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Create a relational data model&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Specify the schema for the data model in SQL&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Create the tables in sqlite3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Implement the service handlers to use the sqlite3 db instead.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Refer to the <a class="reference external" href="https://www.sqlite.org/lang_insert.html">insert into</a> documentation on the syntax. For our simple table, the following hold –</p>
<ol class="arabic simple">
<li><p>The values supplied within parentheses are (and must be) in the same order
in which the columns we declared in the schema (i.e. “create table”
statement).</p></li>
<li><p>String values are given enclosed in single-quote characters. If a string
itself is to include the single quote character, use two single-quotes
instead – like in <code class="docutils literal notranslate"><span class="pre">'this</span> <span class="pre">SQL</span> <span class="pre">string</span> <span class="pre">has</span> <span class="pre">a</span> <span class="pre">''single-quoted''</span> <span class="pre">part'</span></code>.</p></li>
<li><p>The types of the values will be cast to what we specified in the schema. So
if we’d declared “id” to be “TEXT” but gave a number when inserting data,
the number will be converted into a string and stored.</p></li>
<li><p>There is a hidden column available called <code class="docutils literal notranslate"><span class="pre">rowid</span></code> which is also an integer and which
SQLite can auto insert for you, so in our case, we don’t really need an “id” column.</p></li>
<li><p>Supposing we insert a row with an “id” that already exists in the table, it is considered
an error, because we’ve marked the “id” column as being the <code class="docutils literal notranslate"><span class="pre">PRIMARY</span> <span class="pre">KEY</span></code>.</p></li>
</ol>
</section>
<section id="retrieve-rows">
<h2>Retrieve rows<a class="headerlink" href="#retrieve-rows" title="Permalink to this heading">¶</a></h2>
<p>Retrieving rows from a table is done using the <a class="reference external" href="https://www.sqlite.org/lang_select.html">select statement</a>. For example, to retrieve
the set of rows of completed todo items, we can issue the following command –</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">todolist</span>
<span class="k">where</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;complete&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>In the above case, the “*” indicates “get me all the columns in the table”. While this is useful
for debugging and testing on the sqlite3 repl, it is better to be specific about the information
we need. That way, if the schema grew to 10 columns and we only needed two in the first place, we
don’t end up wasting 80% of the data fetched.</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">todolist</span>
<span class="k">where</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;complete&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>While such usage of the select statement is simple to understand, much of the
complexity of working with tables using SQL lies in constructing select
statements. In particular querying information from multiple tables (called
“join operations”) presents much complexity and tricky performance
considerations when tables become large.</p>
</section>
<section id="update-rows">
<h2>Update rows<a class="headerlink" href="#update-rows" title="Permalink to this heading">¶</a></h2>
<p>To mark the “create a relational data model” row as “complete”, we use the
<a class="reference external" href="https://www.sqlite.org/lang_update.html">update</a> statement.</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">update</span><span class="w"> </span><span class="n">todolist</span>
<span class="k">set</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;complete&#39;</span>
<span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</pre></div>
</div>
<p>Note the following –</p>
<ol class="arabic">
<li><p>The <code class="docutils literal notranslate"><span class="pre">where</span> <span class="pre">id</span> <span class="pre">=</span> <span class="pre">5</span></code> part identifies the rfws whose <code class="docutils literal notranslate"><span class="pre">status</span></code> field need to
be marked as <code class="docutils literal notranslate"><span class="pre">complete</span></code>.</p></li>
<li><p>In principle, there could be more than one row identified by the given
constraints. All of them will be updated by the statement. In our case
though, since <code class="docutils literal notranslate"><span class="pre">id</span></code> is the “primary key” for the table, the value <code class="docutils literal notranslate"><span class="pre">5</span></code> is
guaranteed to uniquely identify one row, if it exists.</p>
<div class="admonition-warning admonition">
<p class="admonition-title"><strong>Warning</strong></p>
<p>In general, beware when you make update statements which they’re
destructive updates and you might accidentally match more rows than you
intended to. Remember the “precision” and “recall” concepts. You want
high precision <strong>and</strong> recall for your update statements, but the
precision is more important than the recall, since you can find out
about rows that have not been modified and issue new commands to modify
them. If your selection is has low precision though, you’ll have
modified some rows unintentionally and it can be hard to determine
which rows were affected.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">update</span></code> statements cannot add or remove columns. That is considered a
change in schema and must not be done without careful thought.</p></li>
</ol>
</section>
<section id="indices">
<h2>Indices<a class="headerlink" href="#indices" title="Permalink to this heading">¶</a></h2>
<p>Consider the <code class="docutils literal notranslate"><span class="pre">select</span></code> statement we wrote earlier –</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">todolist</span>
<span class="k">where</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;complete&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>We can imagine that the database engine that runs this program steps through the rows
of the example, examining each row for the conditions indicated in the <code class="docutils literal notranslate"><span class="pre">where</span></code> clause
and returning the requested columns when there is a match. We might think of it as
equivalent to the python “list comprehension” –</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">g_todolist</span>
  <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;complete&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The list comprehension is a useful beginning mental model of querying tables
to have in mind. However, as computer scientists, we can quickly notice that
this is an inefficient means of retrieval since it has to go through the
entire list for each query. What if the list has a million items and only 5
of them have been completed?</p>
<p id="index-2">To speed up such cases, SQL databases can construct auxiliary tables, called
“index tables” or “indices” for short, which maintain additional information
that helps then run such <code class="docutils literal notranslate"><span class="pre">select</span></code> queries fast – often in logarithmic time
complexity. This is a classic case of “trade off some extra storage space for a
great reduction in time”.</p>
<p>These indices are not automatically created though. Since every new index table
places demands on compute and storage, we need to tell the engine explicitly
which indices need to be created for our particular uses.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A good rule of thumb is to list out all the queries you make,
identify the ones that can be expensive without an index and only create
indices over the columns relevant to those queries.</p>
</div>
<p>In this case, if we wish to create an index for the “status” column so we
can quickly locate the pending items (assuming these are far fewer than
the completed items), we can do so like this –</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">idx_todolist_status</span>
<span class="k">on</span><span class="w"> </span><span class="n">todolist</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="p">);</span>
</pre></div>
</div>
<p>While creating such indices manually seems onerous, the saving grace is that
these indices are used by the engine automatically when running <code class="docutils literal notranslate"><span class="pre">select</span></code>
queries and we don’t need to explicitly specify which index to use to speed
things up.</p>
<div class="admonition-performance-note admonition">
<p class="admonition-title"><strong>Performance note</strong></p>
<p>Indices are most effective when there is high information content in a
column. This is why “primary key” columns and “unique” columns benefit the
most, since if we know the value of this column, then we know exactly which
row we need to be looking at. In our case, the “status” column makes for a
weak index because it can take only one of two values and therefore if there
is an even split between the number of “complete” items and “pending” items,
the advantage we gain is not all that much over a simple linear search.</p>
</div>
</section>
<section id="sqlite3-and-python">
<h2>sqlite3 and python<a class="headerlink" href="#sqlite3-and-python" title="Permalink to this heading">¶</a></h2>
<p>The following python code does these steps – you can try these in the python REPL.
We’re creating our “todolist table” in this step using the <a class="reference external" href="https://www.sqlite.org/lang_createtable.html">create table</a> command.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;todolist.db&quot;</span><span class="p">)</span>
<span class="c1"># Now, if you didn&#39;t have a file called &quot;todolist.db&quot; in the current</span>
<span class="c1"># directory, one will be created and opened as a sqlite3 database.</span>
<span class="c1"># If one exists already, sqlite3 will try to open it as a database.</span>
<span class="c1"># In case it isn&#39;t an sqlite3 database, this step will raise an exception.</span>

<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">create table todolist (</span>
<span class="s2">     id INTEGER PRIMARY KEY,</span>
<span class="s2">     text TEXT,</span>
<span class="s2">     status TEXT</span>
<span class="s2"> )</span>
<span class="s2"> &quot;&quot;&quot;</span><span class="p">)</span>
 <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

 <span class="c1"># The above way has a problem. Suppose there was an exception raised during</span>
 <span class="c1"># the `execute` step, then we&#39;ll miss closing the cursor. To avoid this,</span>
 <span class="c1"># we can use the python `with` clause like this --</span>

 <span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>

 <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
     <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;...&quot;&quot;&quot;</span><span class="p">)</span>

 <span class="c1"># The above `with` clause will ensure that the cursor opened is closed</span>
 <span class="c1"># whether or not the SQL statement completes successfully.</span>
 <span class="c1"># We&#39;ll use this approach going forward.</span>
</pre></div>
</div>
<p>Here is an example of how we would typically write functions that call into the
database to retrieve items. We do not construct SQL statements using string
concatenation. Instead we mark the variable parts of the statements using <cite>?</cite>
and supply arguments using a separate python list of arguments.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">items_by_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select text, status from todolist where status = ?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">status</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rows</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also used dictionaries to supply values for named parameters like this -</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">items_by_status</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            select text, status</span>
<span class="s2">            from todolist</span>
<span class="s2">            where status = :status</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span> <span class="p">})</span>
        <span class="k">return</span> <span class="n">rows</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">:status</span></code> marks the named parameter in the SQL statement. The <code class="docutils literal notranslate"><span class="pre">rows</span></code>
object returned by <code class="docutils literal notranslate"><span class="pre">cur.execute</span></code> is an iterator and <code class="docutils literal notranslate"><span class="pre">rows.fetchall()</span></code> is
essentially the same as <code class="docutils literal notranslate"><span class="pre">[r</span> <span class="pre">for</span> <span class="pre">r</span> <span class="pre">in</span> <span class="pre">rows]</span></code>. Naturally, such named parameters
can only be used within programming languages and not at the sqlite3 repl.</p>
<div class="admonition-sql-injection-attack admonition">
<p class="admonition-title"><strong>SQL injection attack</strong></p>
<p>Many early web programs used to present web forms, take values from them,
and construct SQL queries using string concatenation and run the queries
and return the results. Once some of these services started being
commercially signficant, hackers with malicious intent would try to input
SQL expression fragments into these web forms and try to disrupt the SQL
query to retrieve more information than they’re authorized for. This is
called a “SQL injection attack” and is pretty much why the positional and
named parameters exist in the programming language APIs for SQL databases.
The API implementation will construct the SQL query in a safe manner behind
the scenes that won’t permit inadvertent “SQL injection attacks” due to
programmer error.</p>
</div>
</section>
<section id="task">
<h2>Task<a class="headerlink" href="#task" title="Permalink to this heading">¶</a></h2>
<p>Complete your “TODO List” backend but now use a SQLite3 backed database
instead of the global variable <code class="docutils literal notranslate"><span class="pre">g_todolist</span></code> which we used in class.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Comp350: Software design</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell.html">The “shell”</a></li>
<li class="toctree-l1"><a class="reference internal" href="regex.html">Basics of “regular expressions”</a></li>
<li class="toctree-l1"><a class="reference internal" href="minilangs.html">Many mini languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">A student’s guide to git</a></li>
<li class="toctree-l1"><a class="reference internal" href="tips.html">Some utility tips to help you</a></li>
<li class="toctree-l1"><a class="reference internal" href="json.html">JSON</a></li>
<li class="toctree-l1"><a class="reference internal" href="html.html">HTML/XHTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="js.html">A crash course in JS</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest.html">Representational State Transfer (REST)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data modelling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tables">Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sql">SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">SQLite3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#insert-data">Insert data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#retrieve-rows">Retrieve rows</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-rows">Update rows</a></li>
<li class="toctree-l2"><a class="reference internal" href="#indices">Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sqlite3-and-python">sqlite3 and python</a></li>
<li class="toctree-l2"><a class="reference internal" href="#task">Task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="par.html">Concurrency and parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="pim.html">PIM app</a></li>
<li class="toctree-l1"><a class="reference internal" href="trust.html">Trust issues</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="rest.html" title="previous chapter">Representational State Transfer (REST)</a></li>
      <li>Next: <a href="par.html" title="next chapter">Concurrency and parallelism</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2024, Srikumar K. S..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/data.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>